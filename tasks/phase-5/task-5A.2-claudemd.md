# TASK 5A.2: CLAUDE.md Generator (Backend)
> Phase 5 — Brainstorm Wizard | Session A (Backend) | Depends on: Task 5A.1

## What to Build
Generate and maintain the CLAUDE.md project context file that AI agents read automatically. Must stay concise — under 200 lines target, 300 max.

## Changed from Original Spec
- **Trigger simplification**: Removed orchestrator-dependent triggers ("Agent dispatched", "New task dispatched"). Updates now trigger from: blueprint changes, task status changes in `.synk/tasks.json`, and explicit user action (regenerate button or Tauri command).
- **Task status section reads from `.synk/tasks.json`**: The simple task system (built in Task 5B.3) provides the task data. No orchestrator dependency.
- **Per-task context injection deferred**: The original spec described injecting task-specific diagrams into agent prompts when dispatching. Since there's no automated dispatch in manual mode, this is deferred. Users can manually regenerate CLAUDE.md before starting agent sessions.

## Key Size Rules
- Target: under 200 lines / ~4KB
- Only include system architecture diagram (not all 5)
- Max 5 completed tasks shown (rest: "...and N more")
- Max 5 queued tasks shown (rest: "...and N more")
- Max 5 convention bullets
- Task-specific diagrams injected via prompt, NOT into CLAUDE.md

## Separator Line
`---` separates Synk-managed content (above) from user content (below). Synk NEVER overwrites below the separator. On first generation, if CLAUDE.md already exists, preserve everything below separator.

## Auto-Update Triggers

| Trigger | What Updates | How It Fires |
|---------|-------------|-------------|
| Blueprint generated/edited | Architecture section | Frontend calls `claudemd_generate` after blueprint save |
| Task status changed | Completed/In Progress/Queued lists | Frontend calls `claudemd_generate` after task CRUD |
| User clicks "Regenerate CLAUDE.md" | Full rewrite with latest state | Explicit Tauri command from sidebar or export panel |

Note: There are no automatic background triggers. All updates are explicit — the frontend calls the backend command when state changes that should be reflected in CLAUDE.md.

## Generated File Structure

```markdown
# Project: {project_name}

## Overview
{2-line project description from blueprint or .synk/config.json}

## Tech Stack
{bullet list of tech names only}

## Project Blueprint

### System Architecture
` ``mermaid
{architecture diagram from .synk/blueprint.json — ONLY this one diagram}
` ``

## Current Status

### Completed
- [x] {task title} ({branch name})
...and N more completed tasks

### In Progress
- [ ] {task title} — on branch `{branch}`

### Queued
- [ ] {task title}
...and N more queued

## Conventions
- {max 5 convention bullets from .synk/config.json}

## Important Notes
- This file is auto-generated by Synk. Manual edits above will be overwritten.

---

{user's custom notes — never overwritten}
```

## Data Sources
- **Project name/description/tech stack**: Read from `.synk/blueprint.json` (populated by brainstorm wizard)
- **Architecture diagram**: Read from `.synk/blueprint.json` `diagrams.architecture` field
- **Task lists**: Read from `.synk/tasks.json` (simple task system from Task 5B.3)
- **Conventions**: Read from `.synk/config.json` `conventions` array (optional, user-configured)
- **User notes below separator**: Read from existing `CLAUDE.md` on disk

## Trimming Priority (when exceeding 300 lines)
1. First: reduce Completed list to 3 items + count
2. Then: reduce Queued list to 3 items + count
3. Then: simplify architecture diagram (remove subgraph details)
4. Never trim: In Progress items, Conventions, user notes below separator

## First-Generation Safety
1. Check if `CLAUDE.md` already exists at project root
2. If yes: look for `---` separator line
3. Preserve everything below the separator
4. Replace everything above with Synk's generated content
5. If no separator exists: move entire existing content below a new separator

## Deliverables
1. `src-tauri/src/core/claudemd_generator.rs` — `generate()`, `get_line_count()`
2. `src-tauri/src/commands/claudemd.rs` — Tauri command `claudemd_generate`
3. Template rendering that reads from `.synk/blueprint.json` and `.synk/tasks.json`
4. Size enforcement: auto-trim when exceeding 300 lines
5. Separator preservation: detect `---`, keep everything below
6. First-generation safety: handle existing CLAUDE.md gracefully

## Files to Create/Modify
```
src-tauri/src/core/claudemd_generator.rs  (new)
src-tauri/src/commands/claudemd.rs        (new)
src-tauri/src/commands/mod.rs             (add pub mod claudemd)
src-tauri/src/lib.rs                      (register claudemd_generate command)
src/lib/tauri-api.ts                      (add claudemdGenerate wrapper)
```

## Tauri Command

```typescript
// Generate/regenerate CLAUDE.md for the given project.
// Reads blueprint + tasks from .synk/, writes CLAUDE.md to project root.
invoke('claudemd_generate', {
  args: { projectPath: string }
}) -> { path: string, lineCount: number }
```

## Acceptance Test
Generate CLAUDE.md -> file under 200 lines. Add 20 completed tasks to `.synk/tasks.json` -> only 5 shown + count. Edit manually below `---` -> regenerate -> manual content preserved. Check: only 1 diagram (architecture) included.
